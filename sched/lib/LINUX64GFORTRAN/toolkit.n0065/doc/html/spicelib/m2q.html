
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<HTML>

<HEAD>
   <TITLE>m2q</TITLE>
</HEAD>

<BODY style="color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">
<A name="TOP"></A>

<table style="text-align: left; margin-left: auto; margin-right: auto; width: 800px;"
 border="0" cellpadding="5" cellspacing="2">
  <tbody>
    <tr>
      <td style="background-color: rgb(153, 153, 153); vertical-align: middle; text-align: center;">
      <div align="right"> 
      <small><small><a href="index.html">Index Page</a></small></small>
      </div>
      <b>m2q</b> </td>
    </tr>

    <tr>
      <td style="vertical-align: top;">

<small><div align="center">
<A HREF="index.html#A">A</A>&nbsp;
<A HREF="index.html#B">B</A>&nbsp;
<A HREF="index.html#C">C</A>&nbsp;
<A HREF="index.html#D">D</A>&nbsp;
<A HREF="index.html#E">E</A>&nbsp;
<A HREF="index.html#F">F</A>&nbsp;
<A HREF="index.html#G">G</A>&nbsp;
<A HREF="index.html#H">H</A>&nbsp;
<A HREF="index.html#I">I</A>&nbsp;
<A HREF="index.html#J">J</A>&nbsp;
<A HREF="index.html#K">K</A>&nbsp;
<A HREF="index.html#L">L</A>&nbsp;
<A HREF="index.html#M">M</A>&nbsp;
<A HREF="index.html#N">N</A>&nbsp;
<A HREF="index.html#O">O</A>&nbsp;
<A HREF="index.html#P">P</A>&nbsp;
<A HREF="index.html#Q">Q</A>&nbsp;
<A HREF="index.html#R">R</A>&nbsp;
<A HREF="index.html#S">S</A>&nbsp;
<A HREF="index.html#T">T</A>&nbsp;
<A HREF="index.html#U">U</A>&nbsp;
<A HREF="index.html#V">V</A>&nbsp;
<A HREF="index.html#W">W</A>&nbsp;
<A HREF="index.html#X">X</A>&nbsp;
</div></small>
       <br>
       <table style="text-align: left; width: 60%; margin-left: auto; margin-right: auto;"
       border="0" cellspacing="2" cellpadding="2">
        <tbody>
          <tr>
            <td style="width: 33%; text-align: center;">
            <small>
              <a href="#Procedure">Procedure<br></a>
              <a href="#Abstract">Abstract<br></a>
              <a href="#Required_Reading">Required_Reading<br></a>
              <a href="#Keywords">Keywords<br></a>
              <a href="#Declarations">Declarations<br></a>
              <a href="#Brief_I/O">Brief_I/O<br></a>

              </small>
              </td>
              <td style="vertical-align: top; width: 33%; text-align: center;">
              <small>               <a href="#Detailed_Input">Detailed_Input<br></a>
              <a href="#Detailed_Output">Detailed_Output<br></a>
              <a href="#Parameters">Parameters<br></a>
              <a href="#Exceptions">Exceptions<br></a>
              <a href="#Files">Files<br></a>
              <a href="#Particulars">Particulars<br></a>

              </small>
              </td>
              <td style="vertical-align: top; width: 33%; text-align: center;">
              <small>               <a href="#Examples">Examples<br></a>
              <a href="#Restrictions">Restrictions<br></a>
              <a href="#Literature_References">Literature_References<br></a>
              <a href="#Author_and_Institution">Author_and_Institution<br></a>
              <a href="#Version">Version<br></a>
             </small>
            </td>
          </tr>
        </tbody>
</table>

<h4><a name="Procedure">Procedure</a></h4>
<PRE>
      M2Q ( Matrix to quaternion )

      SUBROUTINE M2Q ( R, Q )
</PRE>
<h4><a name="Abstract">Abstract</a></h4>
<PRE>
     Find a unit quaternion corresponding to a specified rotation
     matrix.
</PRE>
<h4><a name="Required_Reading">Required_Reading</a></h4>
<PRE>
     <a href="../req/rotation.html">ROTATION</a>
</PRE>
<h4><a name="Keywords">Keywords</a></h4>
<PRE>
     MATH
     MATRIX
     ROTATION
</PRE>
<h4><a name="Declarations">Declarations</a></h4>
<PRE>
 
      DOUBLE PRECISION      R ( 3,  3 )
      DOUBLE PRECISION      Q ( 0 : 3 )
 
</PRE>
<h4><a name="Brief_I/O">Brief_I/O</a></h4>
<PRE>
     Variable  I/O  Description
     --------  ---  --------------------------------------------------
     R          I   A rotation matrix.
     Q          O   A unit quaternion representing R.
</PRE>
<h4><a name="Detailed_Input">Detailed_Input</a></h4>
<PRE>
     R              is a rotation matrix.
</PRE>
<h4><a name="Detailed_Output">Detailed_Output</a></h4>
<PRE>
     Q              is a unit-length SPICE-style quaternion
                    representing R. See the discussion of quaternion
                    styles in Particulars below.

                    Q is a 4-dimensional vector. If R rotates vectors
                    in the counterclockwise sense by an angle of theta
                    radians about a unit vector A, where 

                       0 &lt; theta &lt; pi
                         -       -

                    then letting h = theta/2,

                       Q = ( cos(h), sin(h)A ,  sin(h)A ,  sin(h)A ).
                                            1          2          3

                    The restriction that theta must be in the range
                    [0, pi] determines the output quaternion Q
                    uniquely except when theta = pi; in this special
                    case, both of the quaternions

                       Q = ( 0,  A ,  A ,  A  )
                                  1    2    3
                    and

                       Q = ( 0, -A , -A , -A  )
                                  1    2    3

                   are possible outputs.
</PRE>
<h4><a name="Parameters">Parameters</a></h4>
<PRE>
     None.
</PRE>
<h4><a name="Exceptions">Exceptions</a></h4>
<PRE>
     1)   If R is not a rotation matrix, the error SPICE(NOTAROTATION)
          is signaled.
</PRE>
<h4><a name="Files">Files</a></h4>
<PRE>
     None.
</PRE>
<h4><a name="Particulars">Particulars</a></h4>
<PRE>
     A unit quaternion is a 4-dimensional vector for which the sum of
     the squares of the components is 1. Unit quaternions can be used
     to represent rotations in the following way: given a rotation
     angle theta, where

        0 &lt; theta &lt; pi
          -       -

     and a unit vector A, we can represent the transformation that
     rotates vectors in the counterclockwise sense by theta radians
     about A using the quaternion Q, where

        Q = 

        ( cos(theta/2), sin(theta/2)a , sin(theta/2)a , sin(theta/2)a )
                                     1               2               3

     As mentioned in Detailed Output, our restriction on the range of
     theta determines Q uniquely, except when theta = pi.

     The SPICELIB routine <a href="q2m.html">Q2M</a> is an one-sided inverse of this routine:
     given any rotation matrix R, the calls

        CALL <b>M2Q</b> ( R, Q )
        CALL <a href="q2m.html">Q2M</a> ( Q, R )

     leave R unchanged, except for round-off error.  However, the
     calls

        CALL <a href="q2m.html">Q2M</a> ( Q, R )
        CALL <b>M2Q</b> ( R, Q )

     might preserve Q or convert Q to -Q.



     Quaternion Styles
     -----------------

     There are different &quot;styles&quot; of quaternions used in 
     science and engineering applications. Quaternion styles
     are characterized by 

        - The order of quaternion elements

        - The quaternion multiplication formula

        - The convention for associating quaternions
          with rotation matrices

     Two of the commonly used styles are

        - &quot;SPICE&quot;

           &gt; Invented by Sir William Rowan Hamilton
           &gt; Frequently used in mathematics and physics textbooks

        - &quot;Engineering&quot;

           &gt; Widely used in aerospace engineering applications


     SPICELIB subroutine interfaces ALWAYS use SPICE quaternions.
     Quaternions of any other style must be converted to SPICE
     quaternions before they are passed to SPICELIB routines.
     

     Relationship between SPICE and Engineering Quaternions
     ------------------------------------------------------

     Let M be a rotation matrix such that for any vector V, 

        M*V

     is the result of rotating V by theta radians in the 
     counterclockwise direction about unit rotation axis vector A.
     Then the SPICE quaternions representing M are

        (+/-) (  cos(theta/2), 
                 sin(theta/2) A(1),  
                 sin(theta/2) A(2),  
                 sin(theta/2) A(3)  ) 

     while the engineering quaternions representing M are 

        (+/-) ( -sin(theta/2) A(1),  
                -sin(theta/2) A(2),  
                -sin(theta/2) A(3),
                 cos(theta/2)       )

     For both styles of quaternions, if a quaternion q represents
     a rotation matrix M, then -q represents M as well.

     Given an engineering quaternion

        QENG   = ( q0,  q1,  q2,  q3 )

     the equivalent SPICE quaternion is

        QSPICE = ( q3, -q0, -q1, -q2 )


     Associating SPICE Quaternions with Rotation Matrices
     ----------------------------------------------------

     Let FROM and TO be two right-handed reference frames, for
     example, an inertial frame and a spacecraft-fixed frame. Let the
     symbols

        V    ,   V
         FROM     TO

     denote, respectively, an arbitrary vector expressed relative to
     the FROM and TO frames. Let M denote the transformation matrix
     that transforms vectors from frame FROM to frame TO; then

        V   =  M * V
         TO         FROM

     where the expression on the right hand side represents left
     multiplication of the vector by the matrix.

     Then if the unit-length SPICE quaternion q represents M, where

        q = (q0, q1, q2, q3)

     the elements of M are derived from the elements of q as follows:

          +-                                                         -+
          |           2    2                                          |
          | 1 - 2*( q2 + q3 )   2*(q1*q2 - q0*q3)   2*(q1*q3 + q0*q2) |
          |                                                           |
          |                                                           |
          |                               2    2                      |
      M = | 2*(q1*q2 + q0*q3)   1 - 2*( q1 + q3 )   2*(q2*q3 - q0*q1) |
          |                                                           |
          |                                                           |
          |                                                   2    2  |
          | 2*(q1*q3 - q0*q2)   2*(q2*q3 + q0*q1)   1 - 2*( q1 + q2 ) |
          |                                                           |
          +-                                                         -+

     Note that substituting the elements of -q for those of q in the
     right hand side leaves each element of M unchanged; this shows
     that if a quaternion q represents a matrix M, then so does the
     quaternion -q.

     To map the rotation matrix M to a unit quaternion, we start by
     decomposing the rotation matrix as a sum of symmetric
     and skew-symmetric parts:

                                        2
        M = [ I  +  (1-cos(theta)) OMEGA  ] + [ sin(theta) OMEGA ]

                     symmetric                   skew-symmetric


     OMEGA is a skew-symmetric matrix of the form

                   +-             -+
                   |  0   -n3   n2 |
                   |               |
         OMEGA  =  |  n3   0   -n1 |
                   |               |
                   | -n2   n1   0  |
                   +-             -+

     The vector N of matrix entries (n1, n2, n3) is the rotation axis
     of M and theta is M's rotation angle.  Note that N and theta
     are not unique.

     Let

        C = cos(theta/2)
        S = sin(theta/2)

     Then the unit quaternions Q corresponding to M are

        Q = +/- ( C, S*n1, S*n2, S*n3 )

     The mappings between quaternions and the corresponding rotations
     are carried out by the SPICELIB routines

        <a href="q2m.html">Q2M</a> {quaternion to matrix}
        <b>M2Q</b> {matrix to quaternion}

     <b>M2Q</b> always returns a quaternion with scalar part greater than
     or equal to zero.


     SPICE Quaternion Multiplication Formula
     ---------------------------------------

     Given a SPICE quaternion 

        Q = ( q0, q1, q2, q3 )

     corresponding to rotation axis A and angle theta as above, we can
     represent Q using &quot;scalar + vector&quot; notation as follows:

        s =   q0           = cos(theta/2)

        v = ( q1, q2, q3 ) = sin(theta/2) * A

        Q = s + v

     Let Q1 and Q2 be SPICE quaternions with respective scalar
     and vector parts s1, s2 and v1, v2:
 
        Q1 = s1 + v1
        Q2 = s2 + v2

     We represent the dot product of v1 and v2 by

        &lt;v1, v2&gt;

     and the cross product of v1 and v2 by

        v1 x v2

     Then the SPICE quaternion product is

        Q1*Q2 = s1*s2 - &lt;v1,v2&gt;  + s1*v2 + s2*v1 + (v1 x v2)       

     If Q1 and Q2 represent the rotation matrices M1 and M2 
     respectively, then the quaternion product

        Q1*Q2

     represents the matrix product

        M1*M2
</PRE>
<h4><a name="Examples">Examples</a></h4>
<PRE>
     1)  A case amenable to checking by hand calculation:

            To convert the rotation matrix

                     +-              -+
                     |  0     1    0  |
                     |                |
               R  =  | -1     0    0  |
                     |                |
                     |  0     0    1  |
                     +-              -+

            also represented as

               [ pi/2 ]
                       3

            to a quaternion, we can use the code fragment

               CALL ROTATE (  <a href="halfpi.html">HALFPI</a>(),  3,  R  )
               CALL <b>M2Q</b>    (  R,             Q  )

            <b>M2Q</b> will return Q as

               ( sqrt(2)/2, 0, 0, -sqrt(2)/2 )

            Why?  Well, R is a reference frame transformation that
            rotates vectors by -pi/2 radians about the axis vector

               A  = ( 0, 0, 1 )

            Equivalently, R rotates vectors by pi/2 radians in
            the counterclockwise sense about the axis vector 

               -A = ( 0, 0, -1 )  

            so our definition of Q,

               h = theta/2

               Q = ( cos(h), sin(h)A , sin(h)A , sin(h)A  )
                                    1         2         3

            implies that in this case,

               Q =  ( cos(pi/4),  0,  0, -sin(pi/4)  )

                 =  ( sqrt(2)/2,  0,  0, -sqrt(2)/2  )


     2)  Finding a quaternion that represents a rotation specified by
         a set of Euler angles:

            Suppose our original rotation R is the product

               [ TAU ]  [ pi/2 - DELTA ]  [ ALPHA ] 
                      3                 2          3

            The code fragment

               CALL <a href="eul2m.html">EUL2M</a>  ( TAU,   <a href="halfpi.html">HALFPI</a>() - DELTA,   ALPHA,
              .              3,     2,                  3,      R )

               CALL <b>M2Q</b>    ( R, Q )

            yields a quaternion Q that represents R.
</PRE>
<h4><a name="Restrictions">Restrictions</a></h4>
<PRE>
     None.
</PRE>
<h4><a name="Literature_References">Literature_References</a></h4>
<PRE>
     None.
</PRE>
<h4><a name="Author_and_Institution">Author_and_Institution</a></h4>
<PRE>
     N.J. Bachman   (JPL)
     W.L. Taber     (JPL)
   
</PRE>
<h4><a name="Version">Version</a></h4>
<PRE>
    SPICELIB Version 2.0.1, 27-FEB-2008 (NJB)

        Updated header; added information about SPICE 
        quaternion conventions. Made various minor edits
        throughout header.

    SPICELIB Version 2.0.0, 17-SEP-1999 (WLT)

        The routine was re-implemented to sharpen the numerical
        stability of the routine and eliminate calls to SIN
        and COS functions.

    SPICELIB Version 1.0.1, 10-MAR-1992 (WLT)

        Comment section for permuted index source lines was added
        following the header.

    SPICELIB Version 1.0.0, 30-AUG-1990 (NJB)</PRE>
<h4>Link to routine M2Q source file <a href='../../../src/spicelib/m2q.f'>m2q.f</a> </h4>

      </td>
    </tr>
  </tbody>
</table>

   <pre>Tue Jul 15 14:24:37 2014</pre>

</body>
</html>

