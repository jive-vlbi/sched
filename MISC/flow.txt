         SCHED Outline.

This file shows the logical flow of SCHED as of Oct 2003.  
I'm starting with the parts related to setup files.
Trying to do more Aug 29, 2007.
I'm mainly emphasizing where the different subroutines fit 
into the overall picture.


-------------------------------------------------------------------
Top level (see later for details of each called routine):

SCHED:      Main routine
  VERSCHED:  Set the version number.
  STMSG:     Open log.  Write screen info.  Cross check includes.
  Start of restart loop - mainly for plotting.
    INPUT:     Get user and catalog input.
    DEFAULTS:  Fill in the defaults for items not set.
    SCHPRE:    Do precessions etc.
    CHKSC1:    Some scan checks
    SCHOPT:    Determine the actual scans.  Optimize etc.
    DOPFQ:     Set frequencies for line sources.
    GETSUN:    Get sun distance.
    CHKSCN:    More scan checks.     
    SCHSUM:    Write the summary file.
    PLOTTER:   Make plots.
  End of restart loop
  VXWRT:     Write VEX file.
  FLAGS:     Write flagging table.
  STAFILES:  Write antenna files.
  DELSCR:    Delete scratch files etc.

-------------------------------------------------------------------
Details:  Get the input information:

INPUT:
  SCHIN:    Read main user input file (.key file)
    INMAIN:   Define the input parameters (KEYADD and KEYCHR calls)
    SCHOPEN:  Open the input file on a restart.
    Initialize many parameter values, counters etc.
    Start scan loop
      Reset parameters which need it (not many).
      KEYIN:    Read input parameters for scan.
      DIVERT:   Dead end actions.  Only one - list frequencies.
        GETFREQ:  List available LO setups. (details later)


  RDPEAK:   Get reference pointing instructions.
  ACCSRC:   Get all sources used in schedule.
  SRREAD:   Read source catalog.
  SRREAD:   Used again to get sources from pointing catalog.
  GETSET:   Get the setup files.
  GETFREQ:  Read the frequency setups catalog (station LO settings).

-------------------------------------------------------------------
Details:  Fill in defaults and check inputs.

DEFAULTS:  Fill in defaults.
  SRFINISH:  Tie up loose ends from inputs.
    SRCFLG     Associate sources with catalog entries
    JPLGOT     Look for planets among input sources
      JPLEP2     Get planet information
    Don't allow planets with VEX
    SATGOT     Look for a satellite.
      SATEP      Get satellite details
  PKFINISH:  Tie up loose ends related to reference pointing.
  DEFSET:    Set defaults and check setups.
    SETEXPND:  Expand to one station per setup.
      SETSTDEF:  Expand default setups and eliminate unused stations.
      GNSET:     Associate scan/station with setup.
    SETDEFS:   Set a lot of defaults.
      VLAPMODE:  VLA phasing modes
      SETCHAN:   Apply defaults for pol, sample rate, sidebands.
      SETFREQ:   Set frequencies
        SETBAND:   Set frequencies based on BAND.
      SETHW1:    Set hardware items like IFCHAN.
      SETFCAT:   Get frequency catalog data.
      SETBBC:    Assign BBC's.
      SETREC:    Set recorder information
        SETFORM    Set recording format, Initializes TAPEMODE! *********
          TWOHDSET
            SETFMT
            FSPREAD
              SETFMT
            FMTPICK    Pick the format.
              SETFMT     Set tape format stuff.
                FMTS2      S2 format
                FMTMKIII   Mark III format
                FMTVLBA    VLBA format
                FMTMKIV    Mark IV format
            SETNOREC
              SETFMT
          SETSPD:    Set the tape speed
          TPMFIX:    Prevent changes in TAPEMODE
      SETTRK:    Set track assignments

***  maybe move checking to a separate checking routine at the same
 level as DEFAULTS.  I think I can then fold DEFSET and SETDEFS back
into one routine.


    CHKSET:     Check setups.
      Many checks at this level.
      CHKVDAR:    DAR specific checks - VLBA systems
      CHKV4DAR:   DAR specific checks - VLBA systems with MKIV formatter
      CHKGDAR:    DAR specific checks - VLBA geodetic systems
      CHK4DAR:    DAR specific checks - MKIV systems
      CHK4GEO:    DAR specific checks - Geodetic patched MKIV systems
      CHKDISK:    Recorder checks - disk
      CHKVRREC:   Recorder checks - VLBA recorder on MkIV formatter
      CHKSREC:    Recorder checks - S2 system
      CHKSPD:     Bit rate per track and tape speeds.
      CHKVLBA:    Some VLBA specific items.
      CHKVLA:     Some VLA specific items.
    OKMODES:    Check allowed modes.
    CHKSFIL:    Check things that shouldn't vary between setup groups.
    SFINFO:     Get logical channels etc.
    SBPAIR:     Detect signals assigned to same BBC to force same freq.
    CHKSOC:     Checks for Socorro correlator.
    CHKJIVE:    Checks for JIVE correlator
  Default the "grab" controls for data capture.

-------------------------------------------------------------------
Details:  Check scan parameters.  Put in generic check routine?
CHKSC1 - no calls so no details.
-------------------------------------------------------------------
Details:  Determine actual scans:

SCHOPT
  Output scan loop.
    Optimization options:
      OPTNONE:   No optimization
        SCNDUP:    Copy scan if necessary.
      OPTDWELL:  Dwell time scheduling.
        SCNDUP:    Copy scan if necessary.
        OPTGEO:      Get scan geometry, slew times etc. Details later.
      OPTSKD:    Select by number up and some other criteria.
        SCNDUP:    Copy scan if necessary.
        OPTGEO:      Get scan geometry, slew times etc. Details later.
      OPTCELLS:  Geodesy type optimization.
        SCNDUP:    Copy scan if necessary.
        OPTGEO:      Get scan geometry, slew times etc. Details later.
      OPTCSUB:   Like OPTCELLS but with subarrays.
        OPTCSAR:   Try to determine optimal subarrays.
          OPTGEO:    Get scan geometry, slew times etc. Details later.
          OPTCSPT    Get subarray quality factor.
        SCNDUP:    Copy scan if necessary.
      OPTUPT:    String of scans for UPTIME plots.
        SCNDUP:    Copy scan if necessary.
        OPTGEO:      Get scan geometry, slew times etc. Details later.
      OPTHAS:    Automated survey scheduling.
        HALIM:     Get hour angle limits.
          SCHGEO:    Get geometry for a scan. (several calls).
        SCHGEO:    Get geometry for a start and stop times
        HAAVAI:    Get time source available and desired obs time.
        SCHGEO:    Get geometry for a scan. 
        OPTGEO:    Get geometry. Details later.
        SCNDUP:    Copy scan if necessary.
    OPTTIM:    Get slew times, exact start times etc.
      OPTGEO:    Get geometry. Details later.
    SCNGEO:    Get geometry info.
      SCHSRC:    Get geometry details - See under OPTGEO.
      SLEW:      Determine slew times.
    ADDPEAK:   Add pointing scans.
      VLAFREQ:   Get VLA frequency
      SCNDUP:    Copy scan if necessary.
      SRINSERT:  Insert pointing source.
      SCNGEO:  Get geometry.  See above for calls.
    MAKEPTG:   Convert added scans, or user scans, to pointing.
    SCNGEO:    Redo the geometry info.  See above for calls.
    AUTODOWN:  Eliminate stations too low and with autotape.
    SCHTAPE:   Deal with tape.
      SETTPS:   Set tape start time.
      TPTAPE:   Get tape information.  Dummy values for disk.
        TPMK2:    Deal with Mark 2.
          TPPACK:   Fill in TPDAT info with tape bookkeeping.
        TPS2:     Deal with S2
          TPPACK:   Fill in TPDAT info with tape bookkeeping.
        TPSCH:    Deal with VLBA and Mark IV.
                            Deals with not too many passes per head position.
          TPPACK:   Fill in TPDAT info with tape bookkeeping.
          TPAUTO:   Automatic tape handling.
          TPREV:  Reverse tape when not using automatic tape allocation.
        TPPACK:   Fill in TPDAT info with tape bookkeeping.
      DISKPOS:  Get disk information
      TSYNC:    Deal with station-station tape coordination.
        TPTAPE:   See above - used here for synchronized tape change.
    OPTSCH:    Write a SCHED input file with optimized schedule.
  End scan loop.
  ACCSRC:    Accumulate list of sources actually used.
  SRCFLG:    Set pointers between schedule and catalog sources.
* SCHTIM:    Check monotonic time, gaps, and get extreme times.
             A lot of readback bookkeeping and other tape stuff.
  SCH24:     Avoid 24:00:00.
  TPMK2:     Mark 2 tape changes.  Ancient, but still used?
    TPPACK:    Load the tape accounting (not just MK2).

------------------------------------------------------------------------
Subroutine details:  OPTGEO used in optimization routines.

OPTGEO:
  SCHSRC:       Get geometric details
    SCHGEO:       Get geometry at a time.
    WRAP:         Determine if a cable wrap will be done.
    HORCHK:       Function to determine if up or down.
  SLEW:         Get slew times.  

-------------------------------------------------------------------
Details:  Do the doppler calculations.

DOPFQ:     Do the Doppler calculations - mostly self contained.
  SLA_ECOR:  Earth ephemeris.

-------------------------------------------------------------------
Details:  Get sun distance.

GETSUN:   
  SUNPOS:    Get the position of the sun.
    SLA_EARTH:  Get the required positions.
  SLA_DSEP:  Get angle between two sources.
-------------------------------------------------------------------
Details:  Second scan check routine.
   The fset and pset stuff maybe should be in a default setting 
   routine rather than a check routine.  Don't move before DOPFQ.

CHKSCN:    Check scans again, after SCHOPT etc have mucked with them.
  GETFSET:   Get the frequency sets.
  GETPSET:   Get the pcal sets.
*   PCALFQ:    Get the pulse cal settings. (Oops this doesn't belong in 
                a checking routine).
  RESYNC:    Check for possible data loss during corr. resyncs etc.
  VLASCHK:   Check VLA specific items.
-------------------------------------------------------------------
Details:  Summarize the scans (write .sum file):

SCHSUM:    Write .sum file. (long routine).
  TDATECW:   Get date in desired format.
  SUMOPE:    Open the summary file.
    WRTCOV:    Write cover letter.
    CORLST:    Write correlator information.
    STALST:    List the stations.
  SUMSCN:    Write the scan summaries.
    SUNWARN:   Warn if near the sun.
  TPSUM:     Write tape time estimates.
  VXVERS:    Get Vex version.
  PLVER:     Get Plot code version.
  JPLVER:    Get JPL code version.
  PGQINF:    Get PGPLOT version.

-------------------------------------------------------------------
Details:  Plotting.  Franco's part.

PLOTTER:   Beginning of plot stuff.  This will be big.

**********  Fill this in eventually.

-------------------------------------------------------------------
Details:  Write the Vex file.  Cormac's part.

VXWRT:

**********  Fill this in eventually.

-------------------------------------------------------------------
Details:  Write the flagging table.

FLAGS:     Open and write the flag table.
  FLAGWRT:   Actually write the flag line.
  SCHGEO:    Inside a loop to get the rise time.

-------------------------------------------------------------------
Details:  Write the files for the antennas.

STAFILES:  Control the writing of the crd and sch files.
  FILEOPEN:  Open the sch and crd files.
    VLBOPE:    Open a text file.
  PRTSCH:    Write the operator schedule - this routines does most.
    WRTCOV:    Write the cover letter to the file.
    TPPACK:    Use to get tape actions.
    FSFREQ:    Get frequency and bandwidth.
    TDATECW:   Get day and date information.
    SUNWARN:   Print a sun warning if needed.
  CRDWRT:    Call appropriate routine to write output files.
*   SNAP:      Write a snap (Mark III) schedule.  (still used?)
    VLBA:      Write a VLBA telescope control file.
      VLBAEND:   Wrap up schedule on last call (postpass etc).
      VLBAINI:   Get the file started.
      VLBAST:    Get a scan started.
        JPLEP2:    Deal with planets - position changes.
          CONST:     Get some constants from the ephemeris file.
            STATE:     Spice routine.
          JPLPO2:    Do the work - from Bryan Butler.
            SLA_EPJ:   SLA routines
            SLA_GMST:
            SLA_EQEQX:
            SLA_PRECL:
            SLA_NUT:
            SLA_DMXV:
            SLA_DCC2S:
            SLA_DRANRM:
            PLEPH:      JPL routine
            PVOBS:      Bryan's routine.
            FINDT:      Bryan's routine.
            TRANSP:     Bryan's routine.
        SATEP:     Deal with satellites - position changes.  NAIF
          FURNSH:    
          STR2ET:
          SPKEZR:
          ET2UTC:
      VLBATI:    Deal with tape information.
        TPPACK:    Get tape direction etc.
        VLBACHG:   Do a tape change.  Worry about postpass.
      VLBASU:    Write most of the setup information.
        VLBATP:    Write tape motion commands.
        VLBADK:    Write disk motion commands.
        VLBAINT:   Write an integer parameter and values.
        VLBACHAR:  Write a character parameter and values.
        VLBABWS:   Write frequency/bandwidth type parameters.
        VLBAREAL:  Write real parameters.

      VLBACHG:   Do a tape change.  Turn off unused drive.
      VLBATP:    Write tape motion commands.
      VLBADK:    Write disk motion commands.
      PTVLBA:    Write special single dish pointing scans.
        PTPAT:     Write the 12 scan pattern.
      ROTLVBA:   Make a focus/rotation pattern.
        VLBAINT:   Write an integer parameter and values.
        PTPAT:     Write the 12 scan pattern.
      TAVLBA:    Make an on/off pattern.
        VLBAINT:   Write an integer parameter and values.
      PN3DB:     Make a half power tracking scan.
        VLBAINT:   Write an integer parameter and values.
      FSVLBA:    Frequency switching loop.
        VLBAREAL:  Write real parameters.
    CRDVLA:    Write an Observ deck for the VLA.
      SIDTIM:    Get sidereal day and time.
      SLA_DJCL:    Julian conversions.
      CHARS:       Determine first and last non-blank characters.
      JPLEP2:      Planet position (see above).
      GETPTLO:     First LO at Pie Town for PT link.
*   CRDNRAO:   Write an old 140' control file.    (still used?)
  PRTSET:    Write setup information into the sch file.
  SRCLST:    Write source information into the sch file.
  
-------------------------------------------------------------------
Utility routines (most not noted in above outline):

KEYIN:   Read free format input (has numerous subroutines)
KEYPTR:  Get the pointer to specific input in the KEYIN arrays.
KCHAR:   Extract a character string from KEYIN arrays.
KEYADD:  Add an input variable to the KEYIN arrays.
KEYCHR:  Add an input character string to the KEYIN arrays.

WLOG:    Write information to screen and log file.
WRTMSG:  Write a message from $SCHED/catalogs/messages.txt
UPCASE:  Make string upper case.
DWCASE:  Make string lower case.
KPACK:   Put a character string into holerith.
VLBOPE:  OS specific routine to open a file.
ERRLOG:  Write message to screen and log, then quit
ENVIR:   Expand unix environment variables in file names.
TIMEJ:   Get year, day, and time of day from MJD, often for printing.
SCHDAY:  Get time (start etc) in special formats need for control files.
STANO:   Get station number for named antenna.
PRTSCN:  Print scan details.


Spotted deficiencies:

OPTMODE modes list in starting comments not complete.



Mostly I found routines by looking for CALL statements.
That will miss function calls.  Find them by searching 
for FUNCTION   Do that later.

[cwalker Sched]$ grep FUNCTION *.f
badlo.f:      LOGICAL FUNCTION BADLO( PARM, FREQ, FMULT, NADD, 
gnset.f:      INTEGER FUNCTION GNSET( ISCN, ISTA )
headpos.f:      INTEGER FUNCTION HEADPOS( TPINDX, SYSTEM, IHEAD )
horchk.f:      CHARACTER*1 FUNCTION HORCHK( KSTA, HA, AZ, EL, KSRC )
pseti.f:      INTEGER FUNCTION PSETI( ISCN, ISTA )
sameset.f:      LOGICAL FUNCTION SAMESET( KS, JS )
sumdat.f:      CHARACTER*5 FUNCTION SUMDAT( ITEM, ISCN, ISTA )
sumdesc.f:      CHARACTER*100 FUNCTION SUMDESC( ITEM, LENGTH )
vlbastop.f:      CHARACTER*9 FUNCTION VLBASTOP( STOPJ, ADDSEC, LASTDY, TWOPI,
[cwalker Sched]$ 
