!  An example sched input file for VLBA observations at 3mm using
!  the RDBE/MARK5C.  This has to be scheduled as a piggyback 
!  observation with different schedules going to the new and old
!  VLBA control system.  This is forced by the need to do reference
!  pointing on maser sources.  The RDBE with the PFB personality
!  cannot do the fine tuning possible for pointing on masers, and 
!  SCHED is not set up to provide fine frequency control, like from
!  Doppler calculations, for the old BBCs during RDBE projects.
!  Therefore this file is set up to make recordings with the
!  RDBE/MARK5C system based on one pass of SCHED while making control
!  files (crd files) for the old system based on a separate pass
!  of SCHED that sets up the old system.  The scheme for doing this
!  is described in more detail in top notes in the example egrdbe.key.
!  Basically lines that should only be used for one or the other pass
!  begin with "!MARK5A" or "!MARK5C" and there is a script that edits
!  the key file for each pass.

!  This example is adapted from eg3mmb.key with the main change being 
!  the use of an RDBE setup and the use of the piggyback system.

!  The main difference of eg3mmb.key from the other eg3mmx.key 
!  examples is the use of automatic generation of the reference 
!  pointing scans using information from the external file peak.cmd.
!  A major test item in eg3mm_rdbe.key is to see if reference 
!  pointing on masers, with doppler setting, can be mixed with
!  RDBE observations.  The SCHED station file does not know 
!  about mixed old and new systems.  Also the MARK5C schedule
!  must know about the pointing scans in order to set the RF switches.
!  So the MARK5A and MARK5C schedules should be identical, except
!  that the MARK5A only should be requested to do doppler setting
!  of frequencies on the masers.  This means that different 
!  peak.cmd files are needed that invoke different setup files. 

!  Original 2000aug08 Craig Walker and Vivek Dhawan
!  Modified 10oct2000 RCW for better reference pointing.
!  Modified 21nov2000 RCW. Convert to autopeak.
!  eg3mm_rdbe.key developed RCW  Feb. 13, 2012.

! ==========================================================
! =================  Cover Information  ====================
! ==========================================================

! Normally, the MARK5C and MARK5A output would go to separate
! subdirectories of those names.  They would all have the same
! project code.  For this SCHED example, to simplify program 
! testing and bookkeeping, they will all go to the parent
! examples directory with different project codes.  If using this 
! example, only one expcode line should be given, without the
! leading comments.  

!MARK5C expcode = eg3mmrc
!MARK5A expcode = eg3mmra
! expcode eg3mmb  ! when using separate MARK5A and MARK5C directories

 version = 1
 expt    = '3mm RDBE/PFB observing with autopeak'
 piname   = 'Craig Walker'    
 address1 = 'National Radio Astronomy Observatory'  
 address2 = 'P. O. Box O'                           
 address3 = 'Socorro, New Mexico, 87801'
 address4 = ' U.S.A. '
 phone    = '505 835 7247 '    
 obsphone = '505 835 7247 '     
 email    = cwalker@nrao.edu  
 fax      = '505 835 7027 '   

 obstype  = VLBA
 obsmode  = '6cm 128-4-2 '
 note1    = 'Will use reference pointing.' 


! ==========================================================
! ==============  Correlator Information  ==================
! ==========================================================
 
correl   = Socorro
coravg   = 1.0
corchan  = 64
cornant  = 4
corpol   = on
corwtfn  = uniform
corsrcs  = standard
cortape  = DAT
corship1 = 'Craig Walker'
corship2 = 'P. O. Box O'
corship3 = 'Socorro NM 87801'

! ==========================================================
! ==================  Program control  =====================
! ==========================================================
!    Normally SCHED will not overwrite preexisting files. 
!    If you want this protection, comment this following line.
 overwrit
 sumitem = ELA, DWELL, EARLY, SLEW
! ==========================================================
! =====  Line rest frequencies at 7mm, 3mm and 1.3cm.  =====
! ==========================================================

lineinit  /
lineset='SiO431'  restfreq=43122.027, 43122.027  /
lineset='SiO862'  restfreq=86243.4,   86243.4    /
lineset ='H2O'    restfreq=22235.08,  22235.08   /
endlines /    
            
! ==========================================================
! =========Automatic Reference Pointing Control ============
! ==========================================================
!  Use reference pointing with setups, stations, and sources
!  defined in the PEAKFILE.  Only invoke for the MARK5A schedules.
autopeak   !  Use reference pointing.
            !  All control information for reference pointing
            !  is in the following file including specification
            !  of the catalog where pointing sources are found.            
!  pkwatch    !  Print details of the search for pointing sources.

!  Specify the input file with the peaking information.  The
!  RDBE version does not attempt Doppler settings so it would
!  not work for a control of the system that actually does the
!  reference pointing.  Here the old system controls the pointing
!  and the new system needs a dummy in the right band to be sure
!  the RF switches are set right.
!MARK5A   peakfile = $SCHED/catalogs/peak.cmd
!MARK5C   peakfile = $SCHED/catalogs/peak_RDBE.cmd

!  Make the MARK5A schedule no-record.  With no NOREC inputs 
!  later, this will apply to all scans.
!MARK5A  norecord

! ==========================================================
! =============  Source and Station Catalogs  ===============
! ==========================================================
! Station and frequency catalogs are different for new and old systems.

!MARK5A freqfile = $SCHED/catalogs/freq.dat
!MARK5A stafile  = $SCHED/catalogs/stations.dat

!MARK5C freqfile = $SCHED/catalogs/freq_RDBE.dat
!MARK5C stafile  = $SCHED/catalogs/stations_RDBE.dat

! Note that pointing sources are found in sources.pointing (MARK5A)
! or sources_RDBE_PFB.pointing (MARK5C - has no velocities)
! which are invoked from peak.cmd or peak_RDBE.cmd respectively.

! The following file is used for the fringe finders.

srcfile = $SCHED/catalogs/sources.vlba

! This example observes AHSco (SiO maser) in the same mode as 
! the continuum observations as a calibration check.  For that,
! 8 velocities are needed, one for each channel, to spread the
! frequencies.
! The reference pointing insertion will use the 7mm SiO masers
! P-AHSco and others that are in sources.pointing.

srccat /

source='SgrA' RA=17:45:40.0399  DEC=-29:00:28.137  equinox='J2000'
remarks='Galactic center' /

source='AHSco' RA=17:11:16.98 DEC=-32:19:31.2 equinox=j2000 
vel=-7, -7, 100, 100, 200, 200, 300, 300
remarks='SEST. Many spectra on SEST home page.' /

endcat /

! ==========================================================
! =======================  Setup files =====================
! ==========================================================
!  Note that it is no longer necessary to have the pointing
!  setup be similar to the observing setup as long as the 
!  pointing setup has FORMAT = NONE.  Then the formatter is
!  not reconfigured.
!  Strong SiO masers will be used for most of the pointing.  

setini = v3mm-256-8-2.set /
  nchan    = 8
  bits     = 2
  bbfilter = 8.0
  freqref  = 86244.99
  freqoff  =  -11.50,-11.50,-3.50,-3.50,4.50,4.50,12.50,12.50
  netside  =  U, U, U, U, U, U, U, U
  pol      = dual
  /
endset /
setini = '3mm_RDBE.set' /
  dbe      = 'rdbe_pfb'
  firstlo  = 85500.0  nchan = 16    bbfilt = 32.0  
  bits     = 2        sideband = L  netside  = L  pol = dual
  bbsyn    = 912, 912,  880, 880, 848, 848,  816.0, 816,
             784, 784,  752, 752, 720, 720,  688.0, 688
/
endset /



! ==========================================================
! =================  Initial Scan Information  =============
! ==========================================================

year     = 2000
month    = 7
day      = 5
start    = 02:30:00
STATIONS = VLBA_FD, VLBA_PT, VLBA_LA, VLBA_KP, VLBA_MK

! ==========================================================
! ========================  The Scans  =====================
! ==========================================================

pcal=OFF              !  No useful PCAL is available at 3 mm.

!  Start with two scans on 3C273.
!  The first is for pointing.  Rather than have SCHED insert
!  this scan, the use of POINT to make a scan a pointing scan
!  is demonstrated.  With no argument, all stations, regardless
!  of pointing group, are included.  POINT will actually 
!  cause the pointing to be done at 7mm.  The second scan 
!  records data for fringe finding at 3mm.

!MARK5A  setup='v3mm-256-8-2.set' 
!MARK5C  setup='3mm_RDBE.set'

source='3C273'  dur = 10:00  gap = 4:00 point / 
source='3C273'  dur = 10:00  gap = 0:00 /

!  Now do 5 cycles of 2 scans each on SgrA, allowing SCHED 
!  to insert pointing before every other scan by leaving 
!  enough time and by having invoked autopeak above
!  The insertion of the pointing scan(s) is triggered by the
!  presence of a sufficient gap between scans (based on the
!  dwell in the peaking instructions file peak.cmd).
!  Since autopeak is only invoked for the MARK5A, the inserted
!  peaking scans will only appear in those schedules.
!  ******  play with dwell to see if the scans stay in sync *****

rep=5  group=2
source=SgrA    dur = 10:00  gap = 4:00 /
source=SgrA    dur = 10:00  gap = 0:00 /

!  Get autocorrelation spectra on a line source.  This can help
!  with calibration and with troubleshooting.  Sufficient gap
!  is provided so pointing will be inserted.  The doppler setting
!  will only be for the MARK5A.  Turning it off for the both has
!  no effect on the MARK5C - it's already off.

! MARK5A doppler      !  Shift frequency for doppler offsets.
source='AHSco'        !  A nearby strong line source
linena='SiO862'       !  Use the 3mm SiO line
gap=0:10:00 dur=0:02:00 / 
nodop                 !  Turn off the doppler corrections.

!  Now do 5 cycles of two scans like those earlier.
!  Use dwell from here to check that the MARK5A and MARK5C schedules
!  stay in sync.

rep = 5  group = 2
source=SgrA  dwell=0:10:00 gap=0:4:00  /
source=SgrA  dwell=0:10:00 gap=0:0:00  /

!  Insert a fringe finder (strong continuum source).
!  Line sources can help get close, but don't give good delays.

source='3C345' dwell=10:00 gap = 6:00 /

!  Now do 5 more cycles of two scans like those earlier.

rep = 5  group = 2
source=SgrA  dwell=0:10:00 gap=0:4:00  /
source=SgrA  dwell=0:10:00 gap=0:0:00  /

!  Final fringe finder.

source='3C454.3' dwell=10:00 gap = 4:00 /





